define(function(require,exports,module){function o(){var o=$(".loginBox,.loginBox2,.registerBox,.rPasswordBox");return o}function e(o){var e=new x.Popup({msg:'<div class="slideLogin"><div class="tit"><span class="on">密码登录</span><span>验证码登录</span></div><div class="touchslider-viewport"><div class="bd"> <ul><li><input type="text" class="username" placeholder="请输入手机号码" value=""></li><li><input type="password" class="password" placeholder="请输入密码" value=""><span class="prompt"><i class="icon"></i><em>手机输入格式有误/验证码有误</em></span></li></ul><ul style="float: left"><li><input type="text" class="username" placeholder="请输入手机号码"></li><li><input type="text" class="password" placeholder="请输入短信验证码"><button class="getCode">获取短信验证码</button><span class="prompt"><i class="icon"></i><em>手机输入格式有误/验证码有误</em></span></li></ul></div></div></div>',otherMsg:'手机号码用来获取预约码和报告服务码<div class="operate"><a href="javascript:;" title="立即注册" class="registerBtn">立即注册</a><i>/</i> <a href="javascript:;" title="忘记密码" class="rPasswordBtn">忘记密码</a></div>',bOhterMsg:!0,callback:function(){$(".slideLogin").touchSlider({container:this,duration:350,delay:3e3,margin:5,mouseTouch:!0,namespace:"touchslider",next:".touchslider-next",pagination:".tit span",currentClass:"on",prev:".touchslider-prev",complete:function(){},autoplay:!1,viewport:".touchslider-viewport"})},okText:"登录",otherBox:"loginPopupCom loginBox",isHide:!1,okCallback:function(){var a=l();a&&(o&&o.afterLoginFun?d(a,e,"",o.afterLoginFun):d(a,e,"",null))}})}function a(o){new x.Popup({msg:'<div class="tit"><span class="on">新用户注册</span></div><div class="bd"> <ul><li><input type="text" class="username" placeholder="请输入手机号码" value=""></li><li><input type="text" class="verCode" placeholder="请输入短信验证码"><button class="getCode">获取短信验证码</button></li><li><input type="password" class="password" placeholder="请输入密码" value=""><span class="prompt"><i class="icon"></i><em></em></span></li><p><span class="checkbox checked"></span> 我已阅读并同意<a href="/userAgreement" target="_blank">《都安全用户协议》</a></p></ul></div>',otherMsg:"手机号码用来获取预约码和报告服务码",bOhterMsg:!0,callback:function(){},okText:"注册",otherBox:"loginPopupCom registerBox",isHide:!1,okCallback:function(){}})}function n(o){new x.Popup({msg:'<div class="tit"><span class="on">重置密码</span></div><div class="bd"> <ul><li><input type="text" class="username" placeholder="请输入手机号码" value=""></li><li><input type="text" class="verCode" placeholder="请输入短信验证码"><button class="getCode">获取短信验证码</button></li><li><input type="password" class="password" placeholder="请输入密码" value=""><span class="prompt"><i class="icon"></i><em></em></span></li></div>',otherMsg:"手机号码用来获取预约码和报告服务码",bOhterMsg:!0,okText:"确定",otherBox:"loginPopupCom rPasswordBox",isHide:!1,okCallback:function(){var o=l();console.log("data::",o)}})}function t(o){$.ajax({type:"post",url:"/register",data:o.data,beforeSend:function(){$(this).html("正在提交注册……")},success:function(e){o.callback&&o.callback(e,o.type)}})}function i(o){$.ajax({type:"put",url:"/rPassword",data:o.data,success:function(e){o.callback&&o.callback(e,o.type)}})}function s(e){$loginWrap=o(),y=$loginWrap.find(".tit span.on").index()||0,T=$loginWrap.find("ul").eq(y).find(".prompt");var a={password:$loginWrap.find("ul").eq(y).find(".password").val(),account:$loginWrap.find("ul").eq(y).find(".username").val(),verCode:$loginWrap.find(".verCode").val(),loginType:1};return a}function l(o){var e=s(),a={};if(0==y){if(a.loginType=1,!e.account)return void T.show().find("em").html("手机号码不能为空");if(e.account&&!x.check_tel(e.account))return void T.show().find("em").html("手机号码不正确");if(o){if(!e.verCode)return void T.show().find("em").html("短信验证码不能为空");a.verCode=e.verCode}if(!e.password)return void T.show().find("em").html("密码不能为空");a.password=x.md5(e.password)}if(1==y){if(a.loginType=2,!e.account)return void T.show().find("em").html("手机号码不能为空");if(e.account&&!x.check_tel(e.account))return void T.show().find("em").html("手机号码不正确");if(!e.password)return void T.show().find("em").html("验证码不能为空");a.verCode=e.password}return a.account=e.account,a}function c(o){var e=s(),a=o.time||"60",n=o.$self,t={mobile:e.account,domain:o.domain};$.ajax({type:"post",url:"/getVerCode",data:t,beforeSend:function(){n.html("正在获取验证码……")},success:function(o){var o=JSON.parse(o);o.success?r(n,a):(T.show().find("em").html(o.msg),n.html("重新获取"))}})}function r(o,e){o.addClass("disable").attr("disabled",!0);var a=setInterval(function(){e--,o.html(e+"秒后可重新获取"),0==e&&(clearInterval(a),o.html("重新获取"),validCode=!0,o.removeClass("disable").attr("disabled",!1))},1e3)}function d(o,e,a,n){var t=$(".loginBox,.loginBox2"),i=t.find(".tit span.on").index();T=t.find("ul").eq(i).find(".prompt"),$.ajax({type:"post",url:"/login",data:o,success:function(o){var o=JSON.parse(o);if(o.success){g();var t=new x.MsgShow({delayTime:2e3,title:'<i class="icon"></i>登录成功!',otherBox:"successBox"}),i=o.data.userAllInfo;e?e.hideBox(function(){k.html(B),n&&n(i)}):a&&n&&n(i),t.hideMsg(1e3)}else{var s=o.code;300==s?T.show().find("em").html("登录失败:服务器异常"):T.show().find("em").html(o.msg)}}})}function u(){x.SendAjax({url:"/logout",param:{},method:"POST",tipText:"退出登录",callback:function(o){o.success&&(S.html("0"),P.forEach(function(o){-1!=w.search(o)?window.location.href="/":k.html(C)}))}})}function p(o){x.SendAjax({url:"/hasBindHis",param:{accountId:o.accountId,send:!0},method:"POST",tipText:"检查是否完善信息",callback:function(e){o.callback&&o.callback(e)}})}function m(o){x.SendAjax({url:"/checkLogin",param:{},method:"GET",tipText:"检查是否登录",callback:function(a){return a.login?void(o&&o()):(e({afterLoginFun:o}),!1)}})}function f(o){var e=new x.Popup({msg:'<div class="box-header">完善信息<i class="icon close closePopup"></i></div><div class="box-body"><ul class="tip-box"><li>为了能正常使用预约挂号服务,请及时补充以下材料。</li><li>以下信息为预约时所需项,一经填写不可更改,提交前请检查核对。</li><li>绑定已有客户编号,您可在病例中心中查看历史报告。</li></ul><form name="accInfoForm"><ul class="info-box"><li><label><i class="text-stress">* </i>姓名</label><input name="name"/></li><li><label><i class="text-stress">* </i>性别</label><div id="gender" class="select-box none"><div class="selected"><span class="text"><span class="text-sec">请选择</span></span><i class="icon pull-down"></i></div><ul class="options"><li class="option" data-value="1">男</li><li class="option" data-value="2">女</li></ul></div></li><li><label><i class="text-stress">* </i>出生年月</label><input id="birthday" name="birthday" readonly/></li><li><label></label><input name="patientCode" placeholder="请输入已有客户编码"/></li><span class="prompt"><i class="icon"></i><em>客户编码有误</em></span></ul></form></div>',otherMsg:"confirm-btn",popupBox:"popupBox",okText:"提交",cancel:"closePopup",otherBox:"complete-dialog",isHide:!1,cancelFun:function(){var e=document.referrer;e=e?"/searchs/report"==w?"/":e:"/",o&&o.back&&o.back&&(window.location.href=e)},okCallback:function(){h(e)}})}function h(o){var e=$(".complete-dialog"),a=e.find("[name=name]").val().trim(),n=e.find("[name=birthday]").val().trim(),t=e.find("#gender .option.active").attr("data-value");if(!(a&&n&&t))return e.find(".prompt em").html("必输项不能为空"),e.find(".prompt").show(),!1;var i=$(".complete-dialog span.ok");i.addClass("disabled").off("click");var s=$("form[name=accInfoForm]").serialize()+"&gender="+t;x.SendAjax({url:"/users/account/complete",param:s,method:"POST",tipText:"完善信息",callback:function(e){var a=new x.MsgShow({delayTime:2e3,title:'<i class="icon"></i>完善成功!',otherBox:"successBox"});o.hideBox(),a.hideMsg(1e3)},errorFun:function(a){a.data&&(e.find(".prompt em").html("客户编码有误"),e.find(".prompt").show()),i.removeClass("disabled").on("click",function(){h(o)})}})}function g(o){x.SendAjax({url:"/trade/cart/GetCartCount",param:{},method:"GET",tipText:"获取购物车数量",callback:function(o){if(o.success){var e=o.data||"0";S.html(e)}}})}function v(){var o=parseInt(S.text())+1;S.text(o)}function b(){var o=parseInt(S.text())-1;S.text(o)}var x=require("./libs/utils");require("moment"),require("daterangepicker");var w=window.location.pathname;$("body");(x.mobile||"/login"!=w&&"/register"!=w&&"/rPassword"!=w)&&!$(".loginBox2").length||($(".topBar").css({height:0,overflow:"hidden"}),$(".header").css({margin:0}));var k=$(".topBar_info aside"),C='<a href="javascript:;" class="loginBtn">登录</a>',B='<a href="/trade/order/list" class="logout">个人中心</a><i class="icon devidel"></i><a href="javascript:;" class="logoutBtn">退出</a>',y="",T="";$("body").on("click",".getCode",function(){$loginWrap=o();var e=s(),a=$(this);if(!e.account)return void T.show().find("em").html("手机号码不能为空");if(e.account&&!x.check_tel(e.account))return void T.show().find("em").html("手机号码不正确");var n="DAQ-WEB-LOGIN",t=a.parents(".loginCom,.loginPopupCom");t.hasClass("registerBox")?n="DAQ-REG":t.hasClass("loginBox2")?n="DAQ-WEB-LOGIN":t.hasClass("rPasswordBox")&&(n="DAQ-FINDPWD"),e&&e.account&&c({$self:a,time:60,domain:n})}),$("body").on("click",".loginBox .tit span,.loginBox2 .tit span",function(){var e=o();e.find(".tit span.on").index()}),$("body").on("click","ul p",function(){var e=o(),a=e.find(".submitBox .ok"),n=($(this),e.find(".tit span.on").index()),t=e.find("ul").eq(n).find(".checkbox");t.toggleClass("checked"),t.hasClass("checked")?a.removeClass("disabled").attr("disabled",!1):a.addClass("disabled").attr("disabled",!0)}),$("body").on("click",".loginBtn",function(){e({afterLoginFun:function(o){p({accountId:o.accountCommon.id,callback:function(o){o.success&&(o.data||(f(),x.BuildSelect($("#gender")),$("#birthday").daterangepicker({singleDatePicker:!0,showDropdowns:!0,autoUpdateInput:!1,locale:{format:"YYYY-MM-DD",daysOfWeek:["日","一","二","三","四","五","六"],monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"]}},function(o,e,a){$("#birthday").val(o.format("YYYY-MM-DD"))})))}})}})}),$("body").on("click",".logoutBtn",function(){u()}),$("body").on("click",".registerBtn",function(){a()}),$("body").on("click",".rPasswordBtn",function(){n()}),$("body").on("click keyup keydown change",".username,.password,.verCode",function(){var e=o(),a=e.find(".tit span.on").index();e.find("ul").eq(a).find(".prompt").hide()}),$(".loginBox2").length&&$(".loginBox2").touchSlider({container:this,duration:350,delay:3e3,margin:5,mouseTouch:!0,namespace:"touchslider",next:".touchslider-next",pagination:".tit span",currentClass:"on",prev:".touchslider-prev",autoplay:!1,viewport:".touchslider-viewport"}),$("body").on("click",".loginBox2 .ok",function(){var o=l();console.log("data:",o);var e=$("#redirectUrl").val()||"/";o&&d(o,null,e,function(o){p({accountId:o.accountCommon.id,callback:function(o){o.success&&(o.data?window.location.href=e:window.location.href="/users/account/info")}})})}),$("body").on("click",".registerBox .ok",function(){var o=l(!0),a=$(this);o&&t({data:o,callback:function(o){var o=JSON.parse(o),n=a.parents(".registerBox");n.hasClass("loginCom")?o.success?(console.log(o.msg),x.ShowComfirmDialog({tipText:o.msg+"<p>即将跳转登录……</p>",noConfirmBtn:!0,callback:function(){console.log("弹框开始渲染"),setTimeout(function(){window.location.href="/login"},2e3)}})):"账号已注册，请直接登录"==o.msg||"99999999"==o.code?setTimeout(function(){window.location.href="/login"},2e3):T.show().find("em").html(o.msg):o.success?x.ShowComfirmDialog({tipText:o.msg,noConfirmBtn:!0,callback:function(){setTimeout(function(){e()},2e3)}}):(console.log("json.msg:",o.msg),$(".prompt").show().find("em").html(o.msg))}})}),$("body").on("click",".rPasswordBox .ok",function(){var o=l(!0),a=$(this);o&&i({data:o,callback:function(o){var o=JSON.parse(o),n=a.parents(".rPasswordBox");o.success?x.ShowComfirmDialog({tipText:"密码找回成功<p>即将跳转登录……</p>",noConfirmBtn:!0,callback:function(){setTimeout(function(){n.hasClass("loginCom")?window.location.href="/login":e()},2e3)}}):T.show().find("em").html(o.msg)}})});var P=["/trade/order","/trade/cart/list","/treats/reg/","/users/"],S=$(".cartNum");module.exports={showLogin:e,CheckLogin:m,getCartCount:g,cartCoutAddOne:v,cartCoutDelOne:b,showAccountDialog:f}});