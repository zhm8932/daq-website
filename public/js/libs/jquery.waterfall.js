!function(t){"function"==typeof define&&define.amd&&define(["jquery"],t),"function"==typeof define?define(["jquery"],function(){return t(jQuery,window,document,void 0)}):t(window.jQuery||window.Zepto)}(function(t){function i(i,o){this.$element=t(i),this.options=t.extend(!0,{},e,o),this.ajaxLoading=!1,this.colHeightArray=[],this._init()}var o=t(window),n="waterfall",e={itemClass:"waterfall-item",spacingWidth:10,spacingHeight:10,OtherHeight:10,minColCount:2,resizeable:!1,itemAlign:"center",isFadeIn:!0,ajaxCallback:null};i.prototype={constructor:i,_init:function(){var t=this;console.log("开始"),o.on("load",function(){console.log("load事件"),t._positionAll()}),this.options.resizeable&&o.on("resize",function(){console.log("resize事件"),t._positionAll()}),t._positionAll(),this._doScroll()},_getColumnCount:function(){var i=this.$element.width(),o=t(this.options.itemClass),n=o.eq(0).outerWidth(),e=Math.floor(i/(n+this.options.spacingWidth)),s=0,l=0;e=e>this.options.minColCount?e:this.options.minColCount,s=e*n,i>s&&(l=Math.floor((i-s-e*this.options.spacingWidth)/2)),this.itemWidth=n,this.cols=e,this.leftOffset="center"==this.options.itemAlign?l:0},_positionAll:function(){var i,o,n=this,e=t(this.options.itemClass),s=t(".item_list .wrapper").width(),l=t(window).width();console.log("wrapperW:",s),console.log("winW:",l),console.log("winW:",t(".wrapper")),this._getColumnCount(),this.colHeightArray=[],e.each(function(a){t(this).css("position","absolute"),a<n.cols?(t(this).css("top",0),t(this).css("left",n.leftOffset+a*n.itemWidth+a*n.options.spacingWidth),n.colHeightArray.push(t(this).outerHeight())):(console.log("left:",e.eq(o).offset()&&e.eq(o).offset().left),console.log("left:",e.eq(o).offset()&&e.eq(o).offset().left-(l-s)/2),i=Math.min.apply(null,n.colHeightArray),o=t.inArray(i,n.colHeightArray),console.log("minHeight:",i),t(this).css("top",i+n.options.spacingHeight),t(this).css("left",0),n.colHeightArray[o]+=t(this).outerHeight()+n.options.spacingHeight),n.options.isFadeIn&&t(this).animate({opacity:1},300)}),this.$element.css("height",Math.max.apply(null,n.colHeightArray))},_doScroll:function(){var i,n=this;o.on("scroll",function(){i&&clearTimeout(i),i=setTimeout(function(){var i=t(n.options.itemClass).last(),e=o.scrollTop()+o.height()-n.options.OtherHeight;!n.ajaxLoading&&e>i.offset().top+i.outerHeight()/2&&(n.ajaxLoading=!0,n.options.ajaxCallback&&n.options.ajaxCallback(function(){n._positionAll()},function(){n.ajaxLoading=!1}))},100)})}},t.fn[n]=function(o){return this.each(function(){t.data(this,"plugin_"+n)||t.data(this,"plugin_"+n,new i(this,o))}),this}});